node {

    project = "cloud-platforms"
    def DIR = "/opt/gcp"
    def workspace = pwd()
    def repositoryUrl = "https://github.com/joehmchiu/${project}.git"
    def branch = "master"

    withEnv(["PATH+ANSIBLE=${tool 'ansible-2.4.2.0'}"]) {

        stage 'Init Working Env'
        sh 'sudo /opt/vars/init.sh'

        stage 'Check List'
        echo "\u2600 workspace=${workspace}/"
        sh "ls -lrth /tmp/"

        stage 'Check Ansible Availability'
        sh 'which ansible'

        stage 'Check Ansible Version'
        sh 'ansible --version'

        stage 'SCM Update'
        git url: repositoryUrl, branch: branch
        sh "sudo cp -rf ./gcp/* ${DIR}/."

        stage 'Run Playbook Tasks'
        ansiblePlaybook (
            playbook: "/opt/gcp/start-vms.yml",
            sudo: true
        )

        stage "Tasks Logged"
        sh 'sudo /opt/vars/log.sh "VMs powered on"'
    }
}
